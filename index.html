<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TLV Pasta</title>
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      box-sizing: border-box;
    }

    .center {
      text-align: center;
    }

    img {
      max-width: 100%;
      height: auto;
    }

    textarea {
      width: 100%;
      height: 120px;
      font-family: monospace;
      margin-bottom: 10px;
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      resize: none;
      text-align: left;
      line-height: 1.5;
    }

    button {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      cursor: pointer;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    #mainMenu button {
      margin-top: 10px;
      font-size: 20px;
      padding: 15px;
    }

    .back-button {
      background-color: #007bff;
      color: white;
      padding: 15px 12px;
      font-size: 20px;
      border: 1px solid #0056b3;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      margin-top: 20px;
    }

    .back-button:hover {
      background-color: #0056b3;
      border-color: #004085;
    }

    pre {
      background: #f4f4f4;
      padding: 10px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 20px;
    }

    #greeting {
      font-size: 20px;
      margin-top: 20px;
      font-weight: bold;
    }

    #description {
      font-size: 16px;
      margin-bottom: 10px;
    }

    #crcOutput {
      font-size: 28px;
      font-weight: bold;
      margin-top: 10px;
      padding: 10px;
      background-color: #e0ffe0;
      border: 1px solid #a0c0a0;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #crcOutput.copied {
      background-color: #c0ffc0;
    }

    .qrcode-frame {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      display: inline-block;
      margin-top: 20px;
      text-align: center;
    }

    #qrcodeDisplay {
      background-color: white;
      display: inline-block;
    }

    #qrcodeDisplay table,
    #qrcodeDisplay canvas {
      margin: 10px auto;
      display: block;
    }
  </style>
</head>
<body>

  <div id="mainMenu" class="center">
    <h1>TLV & CRC Tool</h1>
    <img src="https://media1.tenor.com/m/bxeM9N2IXLsAAAAd/osita-osita-iheme.gif" alt="Kitty GIF" style="height: 100px; margin-bottom: 20px;">
    <div id="greeting"></div>
    <h2>Select an Option:</h2>
    <button onclick="showSection('tlvDecoderSection')">Decode Base64</button>
    <button onclick="showSection('crcCheckerSection')">CRC-16 Check Digit</button>
    <button onclick="showSection('qrCodeSection')">Generate QR Code</button>
  </div>

  <div id="tlvDecoderSection" style="display: none;">
    <div class="center">
        <img src="https://media1.tenor.com/m/bxeM9N2IXLsAAAAd/osita-osita-iheme.gif" alt="Kitty GIF" style="height: 100px;">
        <h2>Base64 TLV Decoder</h2>
    </div>
    <textarea id="base64Input" placeholder="Paste Base64 here..."></textarea>
    <button onclick="decodeTLV()">Decode</button>
    <div id="description" class="center"></div>
    <pre id="output"></pre>
    <hr>
    <button onclick="showSection('mainMenu')" class="back-button">&#x2190; Back to Menu</button>
  </div>

  <div id="crcCheckerSection" style="display: none;">
    <div class="center">
        <img src="https://media1.tenor.com/m/bxeM9N2IXLsAAAAd/osita-osita-iheme.gif" alt="Kitty GIF" style="height: 100px;">
        <h2>CRC-16 Check Digit Calculator</h2>
    </div>
    <textarea id="crcInput" placeholder="Enter string for CRC-16..."></textarea>
    <button onclick="calculateCRC16()">Calculate CRC-16</button>
    <div id="crcOutput" class="center" onclick="copyCrcResult()"></div>
    <hr>
    <button onclick="showSection('mainMenu')" class="back-button">&#x2190; Back to Menu</button>
  </div>

  <div id="qrCodeSection" style="display: none;">
    <div class="center">
        <img src="https://media1.tenor.com/m/bxeM9N2IXLsAAAAd/osita-osita-iheme.gif" alt="Kitty GIF" style="height: 100px;">
        <h2>TLV EMVCo to QR Code Generator</h2>
    </div>
    <textarea id="qrInput" placeholder="Paste TLV EMVCo data for QR Code..."></textarea>
    <button onclick="generateQrCodeFeature()">Generate QR Code</button>
    <div class="qrcode-frame center"><div id="qrcodeDisplay"></div></div>
    <hr>
    <button onclick="showSection('mainMenu')" class="back-button">&#x2190; Back to Menu</button>
  </div>

  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script>
    const tagDescriptions = {
      '85': 'Payload Format Indicator',
      '61': 'Application Template',
      '50': 'Application Label',
      '63': 'Application Specific Transparent Template',
      '9F74': 'Protected Data Envelope',
      '4F': 'AID',
      '5A': 'CPAN',
      '5F20': 'Customer Name',
      '5F2D': 'Language',
      '5F50': 'Mail',
      '9F25': 'Last 4 Digits CPAN'
    };

    let qrcodeInstanceForNewSection = null;

    function showSection(sectionId) {
      const sections = ['mainMenu', 'tlvDecoderSection', 'crcCheckerSection', 'qrCodeSection'];
      sections.forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';

      if (sectionId === 'mainMenu') {
          // Clear inputs and outputs but keep greeting intact
          document.getElementById('base64Input').value = '';
          document.getElementById('output').textContent = '';
          document.getElementById('description').textContent = '';

          document.getElementById('crcInput').value = '';
          document.getElementById('crcOutput').textContent = '';

          document.getElementById('qrInput').value = '';
          const qrcodeDiv = document.getElementById('qrcodeDisplay');
          if (qrcodeDiv) qrcodeDiv.innerHTML = '';
          qrcodeInstanceForNewSection = null;
      } else if (sectionId === 'qrCodeSection') {
          const qrcodeDiv = document.getElementById('qrcodeDisplay');
          if (qrcodeDiv) qrcodeDiv.innerHTML = '';
          qrcodeInstanceForNewSection = null;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
        showSection('mainMenu');
        fetchGreeting();
    });

    function fetchGreeting() {
      fetch('https://random-animal-api.vercel.app/api/random-animal')
        .then(res => res.json())
        .then(data => {
          const name = data.city || 'Sahabat Kojo Di Wowo';
          document.getElementById('greeting').innerHTML = `Hi, <span style="color: black; font-weight: bold;">${name}</span>`;
        })
        .catch(() => {
          const fallback = 'Sahabat Kojo Di Wowo';
          document.getElementById('greeting').innerHTML = `Hi, <span style="color: black; font-weight: bold;">${fallback}</span>`;
        });
    }

    function decodeTLV() {
      const base64 = document.getElementById('base64Input').value.trim();
      try {
        const hex = atob(base64).split('').map(c =>
          ('0' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('').toUpperCase();
        const parsed = parseTLV(hex);
        document.getElementById('output').innerHTML = format(parsed);
        document.getElementById('description').textContent = 'This is your parsed TLV string:';
      } catch (e) {
        document.getElementById('output').textContent = '‚ùå Invalid Base64 input';
      }
    }

    function parseTLV(hex) {
      let i = 0;
      const result = {};
      const keepAsHexTags = ['4F', '9F25'];

      while (i < hex.length) {
        let tag = hex.substr(i, 2);
        i += 2;
        if ((parseInt(tag, 16) & 0x1F) === 0x1F) {
          while ((parseInt(hex.substr(i, 2), 16) & 0x80) === 0x80) {
            tag += hex.substr(i, 2);
            i += 2;
          }
          tag += hex.substr(i, 2);
          i += 2;
        }

        let lenByte = parseInt(hex.substr(i, 2), 16);
        i += 2;
        let length = lenByte;
        if ((lenByte & 0x80) !== 0) {
          const lenLen = lenByte & 0x7F;
          length = parseInt(hex.substr(i, lenLen * 2), 16);
          i += lenLen * 2;
        }

        const valueHex = hex.substr(i, length * 2);
        i += length * 2;

        if (tag === '61' || tag === '63') {
          result[tag] = parseTLV(valueHex);
        } else if (tag === '5A') {
          const digits = valueHex.match(/.{2}/g).map(byte => {
            const high = (parseInt(byte, 16) >> 4) & 0xF;
            const low = (parseInt(byte, 16) & 0xF);
            return `${high}${low}`;
          }).join('').replace(/F+$/, '').slice(0, 19);
          result[tag] = digits;
        } else if (keepAsHexTags.includes(tag)) {
          result[tag] = valueHex.toUpperCase();
        } else {
          const ascii = valueHex.match(/.{2}/g).map(h => String.fromCharCode(parseInt(h, 16))).join('').trim();
          result[tag] = ascii;
        }
      }
      return result;
    }

    function format(obj, indent = 0) {
      const pad = '  '.repeat(indent);
      const entries = Object.entries(obj);
      entries.sort(([a], [b]) => (a === '85' ? -1 : b === '85' ? 1 : 0));

      return entries.map(([k, v]) => {
        const desc = tagDescriptions[k] ? ` [${tagDescriptions[k]}]` : '';
        const keyLabel = `"${k}${desc}"`;
        let valueHtml;
        if (typeof v === 'object') {
          valueHtml = `{"\n${format(v, indent + 1)}\n${pad}}`;
        } else {
          valueHtml = `<span style="font-weight:bold">${v}</span>`;
        }
        const isHighlighted = (k === '5A' || k === '5F20');
        const highlightStyle = 'font-size: 24px; background-color: #FFFF99;';
        if (isHighlighted) {
            return `<span style="${highlightStyle}">${pad}${keyLabel}: \"${valueHtml}\"</span>`;
        } else if (typeof v === 'object') {
            return `${pad}${keyLabel}: ${valueHtml}`;
        } else {
            return `${pad}${keyLabel}: \"${valueHtml}\"`;
        }
      }).join(',\n');
    }

    function crc16(dataString) {
        let crc = 0xFFFF;
        const polynomial = 0x1021;
        for (let i = 0; i < dataString.length; i++) {
            let byte = dataString.charCodeAt(i);
            crc ^= byte << 8;
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) {
                    crc = (crc << 1) ^ polynomial;
                } else {
                    crc <<= 1;
                }
            }
        }
        return crc & 0xFFFF;
    }

    let originalCrcOutputText = '';

    function calculateCRC16() {
        const inputString = document.getElementById('crcInput').value;
        const crcOutputElement = document.getElementById('crcOutput');
        if (inputString) {
            const result = crc16(inputString);
            const hexResult = ('0000' + result.toString(16)).slice(-4).toUpperCase();
            originalCrcOutputText = hexResult;
            crcOutputElement.textContent = hexResult;
        } else {
            originalCrcOutputText = 'Please enter a string to calculate CRC-16.';
            crcOutputElement.textContent = originalCrcOutputText;
        }
        crcOutputElement.classList.remove('copied');
    }

    function copyCrcResult() {
        const crcOutputElement = document.getElementById('crcOutput');
        const textToCopy = crcOutputElement.textContent;
        if (textToCopy === 'Please enter a string to calculate CRC-16.' || textToCopy === 'Copied!') {
            return;
        }
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                crcOutputElement.textContent = 'Copied!';
                crcOutputElement.classList.add('copied');
                setTimeout(() => {
                    crcOutputElement.textContent = originalCrcOutputText;
                    crcOutputElement.classList.remove('copied');
                }, 1500);
            })
            .catch(err => {
                console.error('Failed to copy text: ', err);
                crcOutputElement.textContent = 'Copy Failed!';
                setTimeout(() => {
                    crcOutputElement.textContent = originalCrcOutputText;
                }, 1500);
            });
    }

    function generateQrCodeFeature() {
        const inputData = document.getElementById('qrInput').value.trim();
        const qrcodeDiv = document.getElementById('qrcodeDisplay');
        qrcodeDiv.innerHTML = '';
        if (!inputData) {
            qrcodeDiv.textContent = 'Please paste TLV EMVCo data to generate a QR code.';
            return;
        }
        qrcodeInstanceForNewSection = new QRCode(qrcodeDiv, {
            text: inputData,
            width: 256,
            height: 256,
            colorDark : '#000000',
            colorLight : '#ffffff',
            correctLevel : QRCode.CorrectLevel.H
        });
    }
  </script>
</body>
</html>
